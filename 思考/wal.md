### 实现计划：事务日志与崩溃恢复

在单核操作系统中实现事务日志和崩溃恢复功能，主要涉及写前日志（WAL）、日志持久化机制、日志缓冲区管理、以及崩溃恢复机制。这些功能是保证事务持久性和一致性的重要组成部分，特别是在系统崩溃的情况下，能够确保数据恢复到一致的状态。

### 4. 事务日志管理

#### 目标：确保事务的持久性与一致性，能够在系统崩溃后恢复数据。

#### 任务：
1. **实现写前日志（WAL）技术**
    - **写前日志（WAL）** 是一种日志记录机制，要求在对数据进行修改之前，首先记录修改操作到日志中。这样，如果系统崩溃，可以通过日志恢复未完成的操作，保证事务的一致性。
    - **步骤**：
        1. **日志格式设计**：设计日志条目格式，包括事务ID、操作类型（如插入、更新、删除）、数据对象的标识、修改前的数据和修改后的数据。
        2. **日志记录机制**：每当事务进行修改时，首先将操作记录写入日志，而不是直接修改数据。这意味着事务数据在数据库中的实际修改是延迟的，直到事务提交。
        3. **日志刷盘**：在事务提交之前，确保日志条目已经成功写入磁盘（同步写入）。此操作可以通过操作系统的文件系统接口（例如 `fsync()`）确保数据持久化。

2. **设计日志持久化机制**
    - 为了防止数据丢失，日志必须持久存储。设计日志持久化机制以保证日志的可靠性。
    - **步骤**：
        1. **日志文件管理**：定义日志文件格式和日志文件大小限制。当日志文件满时，创建新的日志文件，或者将日志文件切换到备份文件中进行归档。
        2. **日志刷写策略**：使用日志缓冲区来减少频繁的磁盘写入操作，但在事务提交时，确保所有日志都被及时刷写到磁盘，保证数据持久性。

3. **实现日志缓冲区管理**
    - **日志缓冲区管理**旨在减少频繁的磁盘写入，提高性能。日志写入操作通常会先写入内存中的缓冲区，当缓冲区满或达到特定条件时，才将数据批量写入磁盘。
    - **步骤**：
        1. **缓冲区管理**：设计日志缓冲区，记录日志条目，直到缓冲区达到一定大小或者满足写入条件（如事务提交）。
        2. **批量刷写**：定期或在事务提交时，将缓冲区中的日志写入磁盘，确保日志不丢失。

### 5. 崩溃恢复

#### 目标：确保系统在崩溃后能够恢复到一致性状态。

#### 任务：
1. **实现崩溃恢复机制**
    - 崩溃恢复机制的关键是根据日志文件恢复数据。系统在崩溃时，通过查看日志，回滚未提交的事务并重做已提交的事务，确保系统状态的一致性。
    - **步骤**：
        1. **日志回放**：恢复过程分为两个主要阶段：
            - **回滚未提交事务**：检查日志中的事务，如果事务尚未提交（没有 `commit` 操作），则撤销该事务的所有操作。
            - **重做已提交事务**：对于已提交的事务，在系统重启时，根据日志文件重做已提交事务的操作，确保这些事务对数据的修改生效。
        2. **事务标记**：在日志条目中加入事务的状态标记，如 `begin`, `commit`, `rollback` 等，以便在恢复过程中可以识别事务的提交状态。

2. **设计系统恢复流程**
    - **步骤**：
        1. **系统启动时恢复**：系统启动时，首先从日志文件中读取最后一条已提交事务的位置，并根据该位置进行恢复操作。
        2. **回滚未提交事务**：从最后一个已提交事务开始回滚所有未提交的事务。可以通过扫描日志文件，检查事务的提交标记（如 `commit`），对于未提交的事务执行回滚操作。
        3. **重做已提交事务**：从系统崩溃点开始，执行所有已提交的事务，重做其修改操作，确保数据库的一致性。

#### 崩溃恢复的具体步骤：
1. **初始化日志文件**：系统启动时打开日志文件，并扫描日志。
2. **定位最后提交事务**：查找日志中的最后 `commit` 标记，确定崩溃时最后提交的事务。
3. **回滚未提交事务**：从最后一个已提交事务之后的所有日志条目中，回滚未提交的事务。
4. **重做已提交事务**：根据日志中的信息重做所有已提交事务。

#### 示例：日志回放过程
- 假设系统崩溃时有以下日志：
    - `BEGIN T1`
    - `UPDATE account SET balance = 100 WHERE id = 1`
    - `COMMIT T1`
    - `BEGIN T2`
    - `UPDATE account SET balance = 200 WHERE id = 2`
    - `ROLLBACK T2`
    - 系统崩溃

恢复过程：
1. 从最后的 `COMMIT T1` 开始，`T1` 已经提交，因此可以重做该事务。
2. `T2` 由于 `ROLLBACK` 被回滚，因此需要撤销 `T2` 对数据库的任何操作。

### 6. 预期结果

通过实现事务日志与崩溃恢复功能，系统能够在事务提交之前确保操作记录，并在系统崩溃后正确恢复数据。这个过程保证了数据的一致性、持久性和事务隔离性，为系统提供了可靠的数据管理能力。

### 7. 后续优化

在实现基础的事务日志与崩溃恢复机制后，可以进一步优化性能，如：
- 提升日志缓冲区管理的效率，减少磁盘写入的频率。
- 支持事务批量提交和日志压缩，进一步提升系统的吞吐量。
- 考虑更复杂的日志管理策略，如增量日志记录等。

通过这些优化，系统的性能和可靠性将得到显著提升。